<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guide Nginx sur Proxmox | wrajaelhak.fr</title>
    <meta name="description" content="Guide complet pour h√©berger son site web sur un serveur Proxmox avec Nginx, SSL et configuration LXC.">
    <link rel="stylesheet" href="doc-style.css">
</head>
<body>
    <div class="container">
        <h1>Guide complet : H√©berger son site web sur un serveur Proxmox</h1>

        <nav class="toc">
            <div class="toc-title">Table des mati√®res</div>
            <ol>
                <li><a href="#preparation">Pr√©paration et pr√©requis</a></li>
                <li><a href="#lxc">Configuration du LXC</a></li>
                <li><a href="#nginx">Installation et configuration Nginx</a></li>
                <li><a href="#transfert">Transfert des fichiers du site Web</a></li>
                <li><a href="#dns">Configuration du nom de domaine</a></li>
                <li><a href="#portforward">Configuration r√©seau (Port Forwarding)</a></li>
                <li><a href="#ssl">S√©curisation avec SSL/HTTPS</a></li>
                <li><a href="#commandes">Commandes utiles</a></li>
                <li><a href="#depannage">D√©pannage</a></li>
            </ol>
        </nav>

        <hr>

        <h2 id="preparation">1. Pr√©paration et pr√©requis</h2>
        <ul class="checklist">
            <li>Serveur Proxmox fonctionnel</li>
            <li>Conteneur LXC (Debian 12 ou Ubuntu 22.04/24.04)</li>
            <li>Nom de domaine acquis</li>
            <li>Fichiers du site web</li>
        </ul>

        <hr>

        <h2 id="lxc">2. Configuration du LXC</h2>

        <h3>A. Cr√©ation du conteneur LXC dans Proxmox</h3>
        <p>Avant d'installer Nginx, on va cr√©er un conteneur LXC sur Proxmox.</p>
        <p>Les param√®tres importants :</p>
        <ul>
            <li><strong>CPU</strong> : 1 core</li>
            <li><strong>RAM</strong> : 512 Mo</li>
            <li><strong>Disque</strong> : 8 Go</li>
            <li><strong>R√©seau</strong> : Adresse IP statique + bridge vmbr0</li>
        </ul>

        <h3>B. Premi√®re connexion et mise √† jour</h3>
        <p>Une fois le conteneur cr√©√©, connectez-vous et mettez √† jour le syst√®me :</p>
        <pre><code>apt update && apt upgrade -y</code></pre>

        <h3>C. Configuration r√©seau</h3>
        <p>V√©rifiez la configuration r√©seau actuelle :</p>
        <pre><code>ip a
cat /etc/network/interfaces</code></pre>

        <p>√âditez le fichier de configuration r√©seau :</p>
        <pre><code>nano /etc/network/interfaces</code></pre>

        <p>Contenu recommand√© :</p>
        <pre><code>auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
    address 192.168.1.100/24
    gateway 192.168.1.1</code></pre>

        <div class="alert alert-warning">
            <p>‚ö†Ô∏è <strong>Important</strong> : La gateway (adresse de votre routeur) est indispensable pour que le serveur soit accessible depuis l'ext√©rieur. Sans elle, votre LXC peut communiquer en local mais pas avec internet.</p>
        </div>

        <p>Appliquez les changements et v√©rifiez la connectivit√© :</p>
        <pre><code>systemctl restart networking
ping -c 4 google.com</code></pre>

        <hr>

        <h2 id="nginx">3. Installation et configuration Nginx</h2>

        <h3>A. Installation de Nginx</h3>
        <pre><code>apt install nginx -y</code></pre>

        <p>D√©marrez le service et activez-le au d√©marrage :</p>
        <pre><code>systemctl start nginx
systemctl enable nginx</code></pre>

        <p>V√©rifiez que Nginx fonctionne :</p>
        <pre><code>systemctl status nginx</code></pre>

        <p><strong>Test rapide :</strong> Ouvrez un navigateur et rendez-vous sur <code>http://192.168.1.100</code>. Vous devriez voir la page par d√©faut de Nginx.</p>

        <h3>B. Structure des r√©pertoires Nginx</h3>
        <div class="directory-structure">/etc/nginx/
‚îú‚îÄ‚îÄ nginx.conf              # Configuration principale
‚îú‚îÄ‚îÄ sites-available/        # Configurations des sites (actifs ou non)
‚îú‚îÄ‚îÄ sites-enabled/          # Sites actifs (liens symboliques)
‚îú‚îÄ‚îÄ conf.d/                 # Configurations additionnelles
‚îî‚îÄ‚îÄ snippets/               # Morceaux de config r√©utilisables

/var/www/
‚îî‚îÄ‚îÄ html/                   # Racine web par d√©faut</div>

        <h3>C. Configuration principale de Nginx</h3>
        <p>Sauvegardez d'abord la configuration originale :</p>
        <pre><code>cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.backup</code></pre>

        <p>√âditez le fichier de configuration :</p>
        <pre><code>nano /etc/nginx/nginx.conf</code></pre>

        <p>Contenu de la configuration :</p>
        <pre><code>user www-data;
worker_processes 1;
pid /run/nginx.pid;
error_log /var/log/nginx/error.log;
include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections 512;
}

http {
    sendfile on;
    tcp_nopush on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    server_tokens off;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    gzip on;
    gzip_types text/css text/javascript application/javascript application/json;
    gzip_min_length 1000;

    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}</code></pre>

        <h3>D. Configuration du site web</h3>
        <p>Cr√©ez le fichier de configuration pour votre site :</p>
        <pre><code>nano /etc/nginx/sites-available/wrajaelhak.fr</code></pre>

        <p>Contenu de la configuration :</p>
        <pre><code>server {
    listen 80;
    listen [::]:80;

    server_name wrajaelhak.fr www.wrajaelhak.fr;

    root /var/www/wrajaelhak.fr;
    index index.html index.htm;

    access_log /var/log/nginx/wrajaelhak-access.log;
    error_log /var/log/nginx/wrajaelhak-error.log;

    location / {
        try_files $uri $uri/ =404;
    }

    location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    location ~ /\. {
        deny all;
    }
}</code></pre>

        <div class="alert alert-info">
            <p>üí° <strong>Note</strong> : Cette configuration est en HTTP uniquement. Certbot ajoutera automatiquement la configuration HTTPS lors de la g√©n√©ration du certificat SSL.</p>
        </div>

        <h3>E. Activer le site</h3>
        <p>Nginx lit uniquement les fichiers pr√©sents dans le dossier <code>sites-enabled/</code> pour afficher les sites. Plut√¥t que de mettre la configuration directement dans ce dossier, on la place dans <code>sites-available/</code> et on cr√©e un raccourci (lien symbolique) vers <code>sites-enabled/</code>.</p>
        <p>L'avantage : si vous voulez d√©sactiver le site temporairement, vous supprimez juste le raccourci. La configuration reste intacte dans <code>sites-available/</code> et vous pouvez r√©activer le site √† tout moment.</p>

        <pre><code>ln -s /etc/nginx/sites-available/wrajaelhak.fr /etc/nginx/sites-enabled/

mkdir -p /var/www/wrajaelhak.fr

chown -R www-data:www-data /var/www/wrajaelhak.fr
chmod -R 755 /var/www/wrajaelhak.fr</code></pre>

        <h3>F. V√©rification et application</h3>
        <p>Testez la configuration Nginx :</p>
        <pre><code>nginx -t</code></pre>

        <p>Si tout est OK, rechargez Nginx :</p>
        <pre><code>systemctl reload nginx</code></pre>

        <hr>

        <h2 id="transfert">4. Transfert des fichiers du site Web</h2>

        <h3>A. Configuration SSH sur le LXC</h3>
        <p>Avant de pouvoir transf√©rer des fichiers, il faut configurer SSH sur le conteneur.</p>
        <pre><code>systemctl status ssh</code></pre>

        <p>Si le serveur SSH n'est pas install√© :</p>
        <pre><code>apt install openssh-server -y

systemctl start ssh
systemctl enable ssh</code></pre>

        <p>Par d√©faut, la connexion root par mot de passe est d√©sactiv√©e. Pour l'activer temporairement :</p>
        <pre><code>nano /etc/ssh/sshd_config</code></pre>

        <p>Trouvez et modifiez cette ligne :</p>
        <pre><code>PermitRootLogin yes</code></pre>

        <p>Puis red√©marrez SSH :</p>
        <pre><code>systemctl restart ssh</code></pre>

        <div class="alert alert-warning">
            <p>‚ö†Ô∏è <strong>S√©curit√©</strong> : Une fois vos fichiers transf√©r√©s, pensez √† d√©sactiver la connexion root par mot de passe et utiliser des cl√©s SSH √† la place.</p>
        </div>

        <h3>B. Transfert des fichiers avec SCP</h3>
        <p>Depuis votre PC :</p>
        <pre><code>scp -r /chemin/vers/mon-site/* root@192.168.1.100:/var/www/wrajaelhak.fr/</code></pre>

        <h3>C. Appliquer les permissions</h3>
        <p>Apr√®s le transfert, attribuez les fichiers √† l'utilisateur Nginx :</p>
        <pre><code>chown -R www-data:www-data /var/www/wrajaelhak.fr</code></pre>

        <hr>

        <h2 id="dns">5. Configuration du nom de domaine</h2>

        <div class="alert alert-warning">
            <p>‚ö†Ô∏è <strong>Important</strong> : Cette √©tape doit √™tre faite <strong>AVANT</strong> de g√©n√©rer le certificat SSL.</p>
        </div>

        <p>Chez votre registrar (OVH, Cloudflare, etc.) configurez les enregistrements DNS :</p>

        <table>
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Nom</th>
                    <th>Valeur</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>A</td>
                    <td>@</td>
                    <td>Votre_IP_Publique</td>
                </tr>
                <tr>
                    <td>A</td>
                    <td>www</td>
                    <td>Votre_IP_Publique</td>
                </tr>
            </tbody>
        </table>

        <p>Pour trouver votre IP publique :</p>
        <pre><code>curl ifconfig.me</code></pre>

        <p>La propagation DNS peut prendre entre 24h-48h. Vous pouvez v√©rifier avec :</p>
        <pre><code>dig wrajaelhak.fr</code></pre>

        <hr>

        <h2 id="portforward">6. Configuration r√©seau (Port Forwarding)</h2>

        <div class="alert alert-warning">
            <p>‚ö†Ô∏è <strong>Important</strong> : Cette √©tape doit √™tre faite <strong>AVANT</strong> de g√©n√©rer le certificat SSL.</p>
        </div>

        <p>Sur votre routeur/box, redirigez les ports vers votre LXC :</p>

        <table>
            <thead>
                <tr>
                    <th>Port externe</th>
                    <th>Port interne</th>
                    <th>Protocole</th>
                    <th>Destination</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>80</td>
                    <td>80</td>
                    <td>TCP</td>
                    <td>192.168.1.100</td>
                </tr>
                <tr>
                    <td>443</td>
                    <td>443</td>
                    <td>TCP</td>
                    <td>192.168.1.100</td>
                </tr>
            </tbody>
        </table>

        <p>La proc√©dure varie selon votre box/routeur. Cherchez une section "NAT", "Port Forwarding" ou "Redirection de ports" dans l'interface d'administration.</p>

        <hr>

        <h2 id="ssl">7. S√©curisation avec SSL/HTTPS</h2>

        <div class="alert alert-warning">
            <p>‚ö†Ô∏è <strong>Pr√©requis</strong> : Les √©tapes 5 (DNS) et 6 (Port Forwarding) doivent √™tre termin√©es. Certbot a besoin d'acc√©der √† votre serveur depuis internet pour valider le certificat.</p>
        </div>

        <h3>A. Installation de Certbot</h3>
        <pre><code>apt install certbot python3-certbot-nginx -y</code></pre>

        <h3>B. G√©n√©ration du certificat SSL</h3>
        <pre><code>certbot --nginx -d wrajaelhak.fr -d www.wrajaelhak.fr</code></pre>

        <p>Suivez les instructions √† l'√©cran. Certbot va :</p>
        <ul>
            <li>V√©rifier que vous √™tes bien propri√©taire du domaine</li>
            <li>G√©n√©rer un certificat SSL gratuit (Let's Encrypt)</li>
            <li>Modifier automatiquement votre configuration Nginx</li>
            <li>Configurer la redirection HTTP ‚Üí HTTPS</li>
        </ul>

        <h3>C. Renouvellement automatique</h3>
        <p>Les certificats Let's Encrypt expirent apr√®s 90 jours. Certbot configure automatiquement un renouvellement. Vous pouvez le tester avec :</p>
        <pre><code>certbot renew --dry-run</code></pre>

        <hr>

        <h2 id="commandes">8. Commandes utiles</h2>
        <pre><code>nginx -t

systemctl reload nginx

systemctl restart nginx

tail -f /var/log/nginx/wrajaelhak-access.log

tail -f /var/log/nginx/wrajaelhak-error.log

rm /etc/nginx/sites-enabled/wrajaelhak.fr

ln -s /etc/nginx/sites-available/wrajaelhak.fr /etc/nginx/sites-enabled/

certbot certificates

certbot renew</code></pre>

        <hr>

        <h2 id="depannage">9. D√©pannage</h2>

        <h3>Le site n'est pas accessible</h3>
        <ol>
            <li>V√©rifiez que Nginx tourne : <code>systemctl status nginx</code></li>
            <li>V√©rifiez la config : <code>nginx -t</code></li>
            <li>V√©rifiez les logs : <code>tail -f /var/log/nginx/error.log</code></li>
            <li>V√©rifiez le port forwarding sur votre routeur</li>
            <li>V√©rifiez que la gateway est configur√©e dans le LXC</li>
        </ol>

        <h3>Certbot √©choue</h3>
        <ol>
            <li>V√©rifiez que le DNS pointe bien vers votre IP : <code>nslookup wrajaelhak.fr</code></li>
            <li>V√©rifiez que le port 80 est accessible depuis l'ext√©rieur</li>
            <li>V√©rifiez les logs Certbot : <code>/var/log/letsencrypt/letsencrypt.log</code></li>
        </ol>

        <h3>Erreur 502 Bad Gateway</h3>
        <p>Le serveur backend ne r√©pond pas. V√©rifiez que votre application est lanc√©e.</p>

        <h3>Erreur 403 Forbidden</h3>
        <p>Probl√®me de permissions. V√©rifiez :</p>
        <pre><code>chown -R www-data:www-data /var/www/wrajaelhak.fr
chmod -R 755 /var/www/wrajaelhak.fr</code></pre>

        <h3>Erreur "Connection refused" en SSH</h3>
        <ol>
            <li>V√©rifiez que SSH est install√© et lanc√© : <code>systemctl status ssh</code></li>
            <li>V√©rifiez que le port 22 est ouvert : <code>ss -tlnp | grep 22</code></li>
        </ol>

    </div>

    <a href="#" class="back-to-top" title="Retour en haut">‚Üë</a>
</body>
</html>
